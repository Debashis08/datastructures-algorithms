name: validate

# Triggers when a PR is opened or updated, targeting 'release' OR 'main'
on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - release
      - main

jobs:
  # --- Job 1: The "Gate" Job ---
  # This job runs first to validate the PR path.
  enforce-branch-strategy:
    runs-on: ubuntu-latest
    steps:
      - name: Block invalid PR path
        # This step ONLY runs if the path is INVALID
        # Wrap the entire logical operation in ${{...}}
        if: ${{ !((startsWith(github.event.pull_request.head.ref, 'feature-') && github.event.pull_request.base.ref == 'release') || (github.event.pull_request.head.ref == 'release' && github.event.pull_request.base.ref == 'main')) }}
        run: |
          echo "::error:: This PR path (${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}) is not allowed."
          echo "::error:: Allowed paths are: 'feature-*' -> 'release' OR 'release' -> 'main'."
          exit 1
      
      - name: Approve valid PR path
        # This step ONLY runs if the path is VALID (for logging)
        if: (startsWith(github.event.pull_request.head.ref, 'feature-') && github.event.pull_request.base.ref == 'release') || (github.event.pull_request.head.ref == 'release' && github.event.pull_request.base.ref == 'main')
        run: |
          echo "Valid PR path. Proceeding to build and test..."

  # --- Job 2: Lint, Build, and Test ---
  lint-build-test:
    # This job WAITS for 'enforce-branch-strategy' to succeed
    needs: enforce-branch-strategy

    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install dependencies
      shell: pwsh
      run: |
        choco install cmake -y
        choco install ninja -y
        choco install llvm -y

    - name: Configure CMake
      shell: pwsh
      run: cmake -S . -B build -G "Ninja" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy
      shell: pwsh
      run: |
        clang-tidy --version
        $files = Get-ChildItem -Recurse -Path source -Include *.cpp,*.cc,*.cxx -File

        # These source/.* files would be checked using .clang-tidy maintained at projectroot
        foreach ($file in $files) {
          Write-Host "Running clang-tidy on source $($file.FullName)"
          clang-tidy -p build "$($file.FullName)" --warnings-as-errors=*
        }

    - name: Build
      shell: pwsh
      run: cmake --build build

    - name: Run tests
      shell: pwsh
      run: ctest --test-dir build --output-on-failure